# =============================================================================
# application.yml - Configuration principale
# =============================================================================
spring:
  application:
    name: nexus-moderation
  
  # Base de données PostgreSQL
  datasource:
    url: jdbc:postgresql://localhost:5432/nexusai
    username: nexusai
    password: nexusai123
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
  
  # JPA & Hibernate
  jpa:
    hibernate:
      ddl-auto: validate  # Utiliser Flyway pour les migrations
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          batch_size: 20
  
  # Flyway (migrations DB)
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
  
  # Redis (cache)
  data:
    redis:
      host: localhost
      port: 6379
      password: 
      timeout: 2000ms
      jedis:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
  
  # Kafka
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3
    consumer:
      group-id: nexus-moderation-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      auto-offset-reset: earliest
      properties:
        spring.json.trusted.packages: com.nexusai.moderation.event.events
  
  # Security
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/auth/realms/nexusai
          jwk-set-uri: http://localhost:8080/auth/realms/nexusai/protocol/openid-connect/certs

# Configuration Modération
moderation:
  # APIs externes
  openai:
    api-key: ${OPENAI_API_KEY}
    moderation-endpoint: https://api.openai.com/v1/moderations
    timeout: 5000
  
  aws:
    region: eu-west-1
    rekognition:
      enabled: true
    access-key: ${AWS_ACCESS_KEY}
    secret-key: ${AWS_SECRET_KEY}
  
  photodna:
    enabled: true
    endpoint: ${PHOTODNA_ENDPOINT}
    api-key: ${PHOTODNA_API_KEY}
  
  # Services internes
  services:
    user-service:
      url: http://localhost:8080
      timeout: 3000
    notification-service:
      url: http://localhost:8085
      timeout: 2000
  
  # Blacklist
  blacklist:
    enabled: true
    reload-interval: 3600000  # 1 heure
    file-path: classpath:blacklists/terms.txt
  
  # Détection détresse
  distress:
    enabled: true
    alert-moderators: true
    send-resources: true

# Actuator (Monitoring)
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

# Logging
logging:
  level:
    root: INFO
    com.nexusai.moderation: DEBUG
    org.springframework.kafka: INFO
    org.hibernate.SQL: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/nexus-moderation.log

# Server
server:
  port: 8084
  error:
    include-message: always
    include-binding-errors: always

---
# =============================================================================
# application-docker.yml - Configuration pour Docker
# =============================================================================
spring:
  config:
    activate:
      on-profile: docker
  
  datasource:
    url: jdbc:postgresql://postgres:5432/nexusai
  
  data:
    redis:
      host: redis
  
  kafka:
    bootstrap-servers: kafka:9092
  
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://user-service:8080/auth/realms/nexusai

moderation:
  services:
    user-service:
      url: http://user-service:8080
    notification-service:
      url: http://notification-service:8085

---
# =============================================================================
# application-production.yml - Configuration Production
# =============================================================================
spring:
  config:
    activate:
      on-profile: production
  
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
  
  data:
    redis:
      host: ${REDIS_HOST}
      password: ${REDIS_PASSWORD}
      ssl: true
  
  kafka:
    bootstrap-servers: ${KAFKA_BROKERS}
    properties:
      security.protocol: SASL_SSL
      sasl.mechanism: PLAIN
      sasl.jaas.config: ${KAFKA_SASL_CONFIG}

moderation:
  openai:
    api-key: ${OPENAI_API_KEY_PROD}
  aws:
    access-key: ${AWS_ACCESS_KEY_PROD}
    secret-key: ${AWS_SECRET_KEY_PROD}

logging:
  level:
    root: WARN
    com.nexusai.moderation: INFO
  file:
    name: /var/log/nexus-moderation/app.log

server:
  port: 8084
  ssl:
    enabled: true
    key-store: ${SSL_KEY_STORE}
    key-store-password: ${SSL_KEY_STORE_PASSWORD}

---
# =============================================================================
# Kafka Topics Configuration
# =============================================================================
# Topics à créer:
#
# moderation.incidents.created:
#   partitions: 3
#   replication-factor: 2
#
# moderation.distress.detected:
#   partitions: 1
#   replication-factor: 2
#
# moderation.user.banned:
#   partitions: 3
#   replication-factor: 2
#
# user.deleted (consumer):
#   - Écoute les suppressions d'utilisateurs
#
# subscription.changed (consumer):
#   - Écoute les changements d'abonnement
