# ============================================================================
# APPLICATION.YML - CONFIGURATION PRINCIPALE
# ============================================================================

spring:
  application:
    name: conversation-service
  
  # =========================================================================
  # MONGODB CONFIGURATION
  # =========================================================================
  data:
    mongodb:
      uri: mongodb://localhost:27017/nexusai_conversations
      database: nexusai_conversations
      auto-index-creation: true
  
  # =========================================================================
  # REDIS CONFIGURATION
  # =========================================================================
  data:
    redis:
      host: localhost
      port: 6379
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
  
  # =========================================================================
  # KAFKA CONFIGURATION
  # =========================================================================
  kafka:
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: all
      retries: 3
    consumer:
      group-id: conversation-service
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: com.nexusai.*

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================
server:
  port: 8080
  compression:
    enabled: true
  http2:
    enabled: true

# ============================================================================
# OPENAI CONFIGURATION
# ============================================================================
openai:
  api-key: ${OPENAI_API_KEY}
  timeout-seconds: 30

# ============================================================================
# ANTHROPIC CONFIGURATION
# ============================================================================
anthropic:
  api-key: ${ANTHROPIC_API_KEY}
  api-url: https://api.anthropic.com/v1/messages
  timeout-seconds: 30

# ============================================================================
# PINECONE CONFIGURATION
# ============================================================================
pinecone:
  api-key: ${PINECONE_API_KEY}
  environment: ${PINECONE_ENVIRONMENT:us-west1-gcp}
  index-name: nexusai-conversations
  namespace-prefix: conv

# ============================================================================
# LLM CONFIGURATION
# ============================================================================
llm:
  default-provider: openai # ou anthropic
  max-tokens: 1000
  temperature: 0.8
  fallback-enabled: true

# ============================================================================
# ACTUATOR & MONITORING
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

# ============================================================================
# LOGGING
# ============================================================================
logging:
  level:
    root: INFO
    com.nexusai.conversation: DEBUG
    org.springframework.data.mongodb: DEBUG
    org.springframework.data.redis: DEBUG
    org.springframework.kafka: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/conversation-service.log
    max-size: 10MB
    max-history: 30

# ============================================================================
# SPRINGDOC (SWAGGER)
# ============================================================================
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    enabled: true

---
# ============================================================================
# PROFIL: DÉVELOPPEMENT
# ============================================================================
spring:
  config:
    activate:
      on-profile: dev

logging:
  level:
    com.nexusai.conversation: TRACE

---
# ============================================================================
# PROFIL: PRODUCTION
# ============================================================================
spring:
  config:
    activate:
      on-profile: prod

  data:
    mongodb:
      uri: ${MONGODB_URI}
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}
  
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS}

logging:
  level:
    root: WARN
    com.nexusai.conversation: INFO

---
# ============================================================================
# DOCKER-COMPOSE.YML
# ============================================================================

# version: '3.8'
# 
# services:
#   # MongoDB
#   mongodb:
#     image: mongo:7.0
#     container_name: nexusai-mongodb
#     ports:
#       - "27017:27017"
#     environment:
#       MONGO_INITDB_ROOT_USERNAME: admin
#       MONGO_INITDB_ROOT_PASSWORD: password
#       MONGO_INITDB_DATABASE: nexusai_conversations
#     volumes:
#       - mongodb-data:/data/db
#     networks:
#       - nexusai-network
# 
#   # Redis
#   redis:
#     image: redis:7-alpine
#     container_name: nexusai-redis
#     ports:
#       - "6379:6379"
#     command: redis-server --requirepass password
#     volumes:
#       - redis-data:/data
#     networks:
#       - nexusai-network
# 
#   # Kafka & Zookeeper
#   zookeeper:
#     image: confluentinc/cp-zookeeper:7.5.0
#     container_name: nexusai-zookeeper
#     environment:
#       ZOOKEEPER_CLIENT_PORT: 2181
#       ZOOKEEPER_TICK_TIME: 2000
#     networks:
#       - nexusai-network
# 
#   kafka:
#     image: confluentinc/cp-kafka:7.5.0
#     container_name: nexusai-kafka
#     depends_on:
#       - zookeeper
#     ports:
#       - "9092:9092"
#     environment:
#       KAFKA_BROKER_ID: 1
#       KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
#       KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
#       KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
#     networks:
#       - nexusai-network
# 
#   # Service Conversation
#   conversation-service:
#     build: .
#     container_name: nexusai-conversation-service
#     depends_on:
#       - mongodb
#       - redis
#       - kafka
#     ports:
#       - "8080:8080"
#     environment:
#       SPRING_PROFILES_ACTIVE: prod
#       MONGODB_URI: mongodb://admin:password@mongodb:27017/nexusai_conversations?authSource=admin
#       REDIS_HOST: redis
#       REDIS_PORT: 6379
#       REDIS_PASSWORD: password
#       KAFKA_BOOTSTRAP_SERVERS: kafka:9092
#       OPENAI_API_KEY: ${OPENAI_API_KEY}
#       ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
#       PINECONE_API_KEY: ${PINECONE_API_KEY}
#       PINECONE_ENVIRONMENT: ${PINECONE_ENVIRONMENT}
#     networks:
#       - nexusai-network
# 
# volumes:
#   mongodb-data:
#   redis-data:
# 
# networks:
#   nexusai-network:
#     driver: bridge

---
# ============================================================================
# DOCKERFILE
# ============================================================================

# # Multi-stage build
# FROM maven:3.9-eclipse-temurin-21 AS build
# WORKDIR /app
# 
# # Copy pom.xml and download dependencies
# COPY pom.xml .
# COPY conversation-common/pom.xml conversation-common/
# COPY conversation-api/pom.xml conversation-api/
# COPY conversation-core/pom.xml conversation-core/
# COPY conversation-llm/pom.xml conversation-llm/
# COPY conversation-memory/pom.xml conversation-memory/
# COPY conversation-persistence/pom.xml conversation-persistence/
# 
# RUN mvn dependency:go-offline
# 
# # Copy source code
# COPY . .
# 
# # Build application
# RUN mvn clean package -DskipTests
# 
# # Runtime stage
# FROM eclipse-temurin:21-jre-alpine
# WORKDIR /app
# 
# # Copy JAR from build stage
# COPY --from=build /app/conversation-api/target/*.jar app.jar
# 
# # Create non-root user
# RUN addgroup -S spring && adduser -S spring -G spring
# USER spring:spring
# 
# # Expose port
# EXPOSE 8080
# 
# # Health check
# HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
#   CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1
# 
# # Run application
# ENTRYPOINT ["java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "app.jar"]

---
# ============================================================================
# .ENV.EXAMPLE
# ============================================================================

# # OpenAI
# OPENAI_API_KEY=sk-...
# 
# # Anthropic
# ANTHROPIC_API_KEY=sk-ant-...
# 
# # Pinecone
# PINECONE_API_KEY=...
# PINECONE_ENVIRONMENT=us-west1-gcp
# 
# # MongoDB (si externe)
# MONGODB_URI=mongodb://user:password@host:27017/nexusai_conversations
# 
# # Redis (si externe)
# REDIS_HOST=localhost
# REDIS_PORT=6379
# REDIS_PASSWORD=password
# 
# # Kafka (si externe)
# KAFKA_BOOTSTRAP_SERVERS=localhost:9092

---
# ============================================================================
# KUBERNETES DEPLOYMENT (k8s/deployment.yml)
# ============================================================================

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: conversation-service
#   namespace: nexusai
# spec:
#   replicas: 3
#   selector:
#     matchLabels:
#       app: conversation-service
#   template:
#     metadata:
#       labels:
#         app: conversation-service
#     spec:
#       containers:
#       - name: conversation-service
#         image: nexusai/conversation-service:1.0.0
#         ports:
#         - containerPort: 8080
#         env:
#         - name: SPRING_PROFILES_ACTIVE
#           value: "prod"
#         - name: MONGODB_URI
#           valueFrom:
#             secretKeyRef:
#               name: mongodb-secret
#               key: uri
#         - name: REDIS_HOST
#           valueFrom:
#             configMapKeyRef:
#               name: redis-config
#               key: host
#         - name: OPENAI_API_KEY
#           valueFrom:
#             secretKeyRef:
#               name: llm-secrets
#               key: openai-key
#         resources:
#           requests:
#             memory: "512Mi"
#             cpu: "500m"
#           limits:
#             memory: "2Gi"
#             cpu: "2000m"
#         livenessProbe:
#           httpGet:
#             path: /actuator/health/liveness
#             port: 8080
#           initialDelaySeconds: 60
#           periodSeconds: 10
#         readinessProbe:
#           httpGet:
#             path: /actuator/health/readiness
#             port: 8080
#           initialDelaySeconds: 30
#           periodSeconds: 5
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: conversation-service
#   namespace: nexusai
# spec:
#   selector:
#     app: conversation-service
#   ports:
#   - protocol: TCP
#     port: 80
#     targetPort: 8080
#   type: LoadBalancer

---
# ============================================================================
# SCRIPT DE DÉMARRAGE (start.sh)
# ============================================================================

# #!/bin/bash
# 
# # Couleurs
# GREEN='\033[0;32m'
# YELLOW='\033[1;33m'
# NC='\033[0m' # No Color
# 
# echo -e "${GREEN}==================================${NC}"
# echo -e "${GREEN}  NexusAI Conversation Service    ${NC}"
# echo -e "${GREEN}==================================${NC}"
# echo ""
# 
# # Vérifier que Docker est installé
# if ! command -v docker &> /dev/null; then
#     echo -e "${YELLOW}Docker n'est pas installé. Veuillez l'installer.${NC}"
#     exit 1
# fi
# 
# # Vérifier le fichier .env
# if [ ! -f .env ]; then
#     echo -e "${YELLOW}.env file not found. Copying from .env.example...${NC}"
#     cp .env.example .env
#     echo -e "${YELLOW}Please edit .env with your credentials.${NC}"
#     exit 1
# fi
# 
# # Charger les variables d'environnement
# export $(cat .env | xargs)
# 
# echo -e "${GREEN}Starting infrastructure...${NC}"
# docker-compose up -d mongodb redis kafka zookeeper
# 
# echo -e "${GREEN}Waiting for services to be ready...${NC}"
# sleep 10
# 
# echo -e "${GREEN}Building application...${NC}"
# mvn clean package -DskipTests
# 
# echo -e "${GREEN}Starting Conversation Service...${NC}"
# java -jar conversation-api/target/conversation-api-1.0.0-SNAPSHOT.jar
# 
# echo -e "${GREEN}Service started on http://localhost:8080${NC}"
# echo -e "${GREEN}Swagger UI: http://localhost:8080/swagger-ui.html${NC}"
# echo -e "${GREEN}Actuator: http://localhost:8080/actuator${NC}"
