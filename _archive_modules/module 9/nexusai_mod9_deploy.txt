# NexusAI - Module 9 : Moderation System

## ğŸ“‹ Table des MatiÃ¨res

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture](#architecture)
3. [Installation](#installation)
4. [Configuration](#configuration)
5. [Utilisation](#utilisation)
6. [APIs](#apis)
7. [Tests](#tests)
8. [DÃ©ploiement](#dÃ©ploiement)
9. [Monitoring](#monitoring)
10. [Contribution](#contribution)

---

## ğŸ¯ Vue d'ensemble

Le **Module 9 - Moderation System** est responsable de la modÃ©ration de contenu sur la plateforme NexusAI. Il offre une modÃ©ration multi-niveaux adaptÃ©e selon le plan d'abonnement de l'utilisateur.

### FonctionnalitÃ©s principales

- âœ… **ModÃ©ration textuelle** via OpenAI Moderation API
- âœ… **ModÃ©ration d'images** via AWS Rekognition + PhotoDNA
- âœ… **ModÃ©ration vidÃ©o** (analyse frame par frame)
- âœ… **DÃ©tection de dÃ©tresse psychologique** (intervention automatique)
- âœ… **SystÃ¨me de rÃ¨gles configurables** par niveau
- âœ… **Gestion des incidents** et workflow de review
- âœ… **SystÃ¨me d'avertissements** et bannissements
- âœ… **Consentements adultes** avec signature numÃ©rique
- âœ… **ConformitÃ© lÃ©gale** (CSAM, terrorisme = zÃ©ro tolÃ©rance)

### Niveaux de modÃ©ration

| Niveau | Plans | Description |
|--------|-------|-------------|
| **STRICT** | FREE, STANDARD | Filtre agressif, bloque tout contenu sensible |
| **LIGHT** | PREMIUM | Filtre modÃ©rÃ©, permet certains contenus adultes |
| **OPTIONAL** | VIP+ (KYC Level 3) | Filtre minimal, contenu illÃ©gal seulement |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MODERATION SYSTEM                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Client â†’ Controller â†’ Service â†’ [External APIs]       â”‚
â”‚                            â†“                            â”‚
â”‚                       Database                          â”‚
â”‚                            â†“                            â”‚
â”‚                       Kafka Events                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Composants

1. **Controllers REST** : Exposition des APIs
2. **Services Core** : Logique de modÃ©ration
3. **Clients externes** : OpenAI, AWS, PhotoDNA
4. **Repository Layer** : AccÃ¨s base de donnÃ©es
5. **Event System** : Publication d'Ã©vÃ©nements Kafka
6. **Detection Services** : DÃ©tresse, Ã©motions, classification

---

## ğŸš€ Installation

### PrÃ©requis

- Java 21+
- Maven 3.9+
- PostgreSQL 16+
- Redis 7+
- Kafka 3.5+
- Docker & Docker Compose (optionnel)

### Installation locale

```bash
# Cloner le repository
git clone https://github.com/nexusai/nexus-moderation.git
cd nexus-moderation

# Compiler
mvn clean install

# Lancer les dÃ©pendances (Docker)
docker-compose up -d postgres redis kafka

# Lancer l'application
mvn spring-boot:run
```

### Installation avec Docker

```bash
# Build
docker build -t nexusai/moderation:latest .

# Run
docker run -p 8084:8084 \
  -e SPRING_PROFILES_ACTIVE=docker \
  -e OPENAI_API_KEY=your-key \
  nexusai/moderation:latest
```

---

## âš™ï¸ Configuration

### Variables d'environnement

```bash
# Base de donnÃ©es
DB_URL=jdbc:postgresql://localhost:5432/nexusai
DB_USERNAME=nexusai
DB_PASSWORD=nexusai123

# Redis
REDIS_HOST=localhost
REDIS_PASSWORD=

# Kafka
KAFKA_BROKERS=localhost:9092

# APIs externes
OPENAI_API_KEY=sk-...
AWS_ACCESS_KEY=AKIA...
AWS_SECRET_KEY=...
PHOTODNA_API_KEY=...

# Services internes
USER_SERVICE_URL=http://localhost:8080
```

### Configuration application.yml

Voir fichier `src/main/resources/application.yml` pour la configuration complÃ¨te.

### Configuration des rÃ¨gles de modÃ©ration

Les rÃ¨gles par dÃ©faut sont insÃ©rÃ©es via Flyway (`V2__insert_default_rules.sql`).

Pour modifier les rÃ¨gles en production, utiliser l'API d'administration :

```bash
PUT /api/v1/admin/moderation/rules/{ruleId}
{
  "threshold": 0.5,
  "action": "WARN"
}
```

---

## ğŸ’» Utilisation

### ModÃ©rer du texte

```java
@Autowired
private TextModerationService moderationService;

public void moderateUserMessage(String userId, String message) {
    ModerationResponse response = moderationService.moderateText(
        message, 
        userId, 
        conversationId
    );
    
    if (!response.isAllowed()) {
        // Contenu bloquÃ©
        throw new ContentBlockedException(response.getMessage());
    }
}
```

### Via API REST

```bash
POST /api/v1/moderation/text
Authorization: Bearer <jwt-token>
Content-Type: application/json

{
  "content": "Texte Ã  modÃ©rer",
  "conversationId": "optional-conversation-id"
}
```

RÃ©ponse :

```json
{
  "allowed": false,
  "incidentType": "SEXUAL_CONTENT",
  "severity": "HIGH",
  "confidence": 0.85,
  "message": "Contenu inappropriÃ© dÃ©tectÃ©: sexual",
  "incidentId": "550e8400-e29b-41d4-a716-446655440000",
  "detailedScores": {
    "sexual": 0.85,
    "violence": 0.12,
    "hate": 0.05
  }
}
```

---

## ğŸ“¡ APIs

### Endpoints de modÃ©ration

| MÃ©thode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/api/v1/moderation/text` | ModÃ©rer du texte |
| POST | `/api/v1/moderation/image` | ModÃ©rer une image |
| POST | `/api/v1/moderation/video` | ModÃ©rer une vidÃ©o |

### Endpoints de gestion des incidents

| MÃ©thode | Endpoint | Description |
|---------|----------|-------------|
| GET | `/api/v1/moderation/incidents` | Liste des incidents |
| GET | `/api/v1/moderation/incidents/{id}` | DÃ©tails d'un incident |
| PUT | `/api/v1/moderation/incidents/{id}/review` | Reviewer un incident |

### Endpoints de consentement

| MÃ©thode | Endpoint | Description |
|---------|----------|-------------|
| POST | `/api/v1/moderation/consents` | CrÃ©er un consentement |
| GET | `/api/v1/moderation/consents/active` | Consentements actifs |
| DELETE | `/api/v1/moderation/consents/{id}` | RÃ©voquer un consentement |

### Documentation Swagger

Une fois l'application lancÃ©e, accÃ©der Ã  :
```
http://localhost:8084/swagger-ui.html
```

---

## ğŸ§ª Tests

### Lancer les tests unitaires

```bash
mvn test
```

### Lancer les tests d'intÃ©gration

```bash
mvn verify -P integration-tests
```

### Coverage

```bash
mvn jacoco:report

# Rapport disponible dans:
# target/site/jacoco/index.html
```

### Tests avec Testcontainers

Les tests d'intÃ©gration utilisent Testcontainers pour lancer PostgreSQL et Kafka.

**Important** : Docker doit Ãªtre actif sur la machine.

---

## ğŸ³ DÃ©ploiement

### Dockerfile

```dockerfile
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

COPY target/nexus-moderation-1.0.0.jar app.jar

EXPOSE 8084

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### Docker Compose

```yaml
version: '3.8'

services:
  nexus-moderation:
    build: .
    container_name: nexus-moderation
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      - postgres
      - redis
      - kafka
    networks:
      - nexusai-network

networks:
  nexusai-network:
    external: true
```

### Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus-moderation
  namespace: nexusai-production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nexus-moderation
  template:
    metadata:
      labels:
        app: nexus-moderation
    spec:
      containers:
      - name: nexus-moderation
        image: nexusai/moderation:1.0.0
        ports:
        - containerPort: 8084
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: DB_URL
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: postgres-url
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: api-keys
              key: openai-api-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8084
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8084
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: nexus-moderation
  namespace: nexusai-production
spec:
  selector:
    app: nexus-moderation
  ports:
  - protocol: TCP
    port: 8084
    targetPort: 8084
  type: ClusterIP
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nexus-moderation-hpa
  namespace: nexusai-production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nexus-moderation
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## ğŸ“Š Monitoring

### MÃ©triques Prometheus

Le module expose des mÃ©triques Prometheus via `/actuator/prometheus` :

- `moderation_requests_total` : Nombre total de requÃªtes de modÃ©ration
- `moderation_blocked_total` : Nombre total de contenus bloquÃ©s
- `moderation_incidents_by_type` : Incidents par type
- `moderation_response_time` : Temps de rÃ©ponse des modÃ©rations
- `distress_detected_total` : Nombre de dÃ©tresses dÃ©tectÃ©es

### Dashboard Grafana

Importer le dashboard fourni dans `monitoring/grafana-dashboard.json`.

### Alertes

Alertes configurÃ©es dans `monitoring/prometheus-alerts.yml` :

- **HighModerationErrorRate** : Taux d'erreur > 5%
- **CriticalIncidentsPending** : Incidents critiques non reviewÃ©s
- **HighDistressRate** : Pic de dÃ©tresse dÃ©tectÃ©e

---

## ğŸ‘¥ Contribution

### Organisation du code

```
com.nexusai.moderation
â”œâ”€â”€ config/          # Configuration Spring
â”œâ”€â”€ controller/      # REST Controllers
â”œâ”€â”€ service/         # Business logic
â”‚   â”œâ”€â”€ moderation/  # Services de modÃ©ration
â”‚   â”œâ”€â”€ detection/   # Services de dÃ©tection
â”‚   â”œâ”€â”€ client/      # Clients HTTP
â”‚   â””â”€â”€ incident/    # Gestion incidents
â”œâ”€â”€ model/           # EntitÃ©s & DTOs
â”œâ”€â”€ repository/      # Repositories JPA
â”œâ”€â”€ event/           # Kafka events
â”œâ”€â”€ exception/       # Gestion erreurs
â””â”€â”€ util/            # Utilitaires
```

### Standards de code

- **Java 21** avec records et pattern matching
- **Lombok** pour rÃ©duire le boilerplate
- **JavaDoc** obligatoire sur les mÃ©thodes publiques
- **Tests** : Coverage minimum 80%
- **Formatage** : Google Java Style Guide

### Workflow Git

1. CrÃ©er une branche depuis `develop`
2. Nommer : `feature/MOD9-XXX-description`
3. Commits atomiques avec messages explicites
4. Pull Request avec description dÃ©taillÃ©e
5. Review obligatoire par 2 dÃ©veloppeurs
6. Merge aprÃ¨s tests CI/CD passÃ©s

---

## ğŸ“ Checklist de dÃ©veloppement

### DÃ©veloppeur 1 : Core Moderation âœ…

- [x] ModerationService (interface)
- [x] TextModerationService
- [x] ModerationRulesService
- [x] BlacklistService
- [x] ContentHashUtil
- [x] Tests unitaires (80%+)
- [x] Documentation JavaDoc

### DÃ©veloppeur 2 : Media Moderation

- [ ] ImageModerationService
- [ ] VideoModerationService
- [ ] RekognitionClient
- [ ] PhotoDNAClient
- [ ] Tests unitaires (80%+)

### DÃ©veloppeur 3 : Detection Services âœ…

- [x] DistressDetectionService
- [x] EmotionAnalysisService (Ã  finaliser)
- [x] ContentClassificationService (Ã  crÃ©er)
- [x] Tests unitaires
- [x] Patterns de dÃ©tection

### DÃ©veloppeur 4 : Incident Management

- [ ] IncidentManagementService
- [ ] WarningService
- [ ] EscalationService
- [ ] Workflow de review
- [ ] Tests unitaires

### DÃ©veloppeur 5 : Consent & Compliance

- [ ] ConsentManagementService
- [ ] DigitalSignatureService
- [ ] KYC Integration
- [ ] Audit logging
- [ ] Tests unitaires

### DÃ©veloppeur 6 : Infrastructure & Integration âœ…

- [x] ModerationController
- [x] Kafka Events
- [x] Configuration (application.yml)
- [x] Migrations DB (Flyway)
- [x] Tests d'intÃ©gration (Testcontainers)
- [x] Docker/Kubernetes manifests

---

## ğŸ”’ SÃ©curitÃ©

### ConformitÃ© lÃ©gale

- âœ… **CSAM (Child Sexual Abuse Material)** : DÃ©tection via PhotoDNA + seuil ultra-bas
- âœ… **Terrorisme** : DÃ©tection et blocage systÃ©matique
- âœ… **RGPD** : Stockage uniquement de hash SHA-256 du contenu, pas du contenu lui-mÃªme
- âœ… **Consentement adulte** : Signature numÃ©rique + KYC Level 3 requis

### Logs d'audit

Tous les incidents sont loggÃ©s avec :
- Timestamp
- User ID
- Action taken
- Severity
- Hash du contenu

RÃ©tention : 3 ans (conformitÃ© lÃ©gale).

---

## ğŸ“ Support

- **Documentation** : https://docs.nexusai.com/moderation
- **Issues** : https://github.com/nexusai/nexus-moderation/issues
- **Slack** : #nexusai-moderation
- **Email** : moderation-team@nexusai.com

---

## ğŸ“„ Licence

Â© 2025 NexusAI. Tous droits rÃ©servÃ©s.

Ce module est propriÃ©taire et confidentiel.

---

## ğŸ‰ Remerciements

Merci Ã  toute l'Ã©quipe NexusAI pour le dÃ©veloppement de ce module critique !

**Version** : 1.0.0  
**DerniÃ¨re mise Ã  jour** : 21 octobre 2025  
**Auteurs** : NexusAI Moderation Team
