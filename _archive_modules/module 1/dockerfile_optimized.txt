# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Multi-Stage Dockerfile pour NexusAI Auth Service
# OptimisÃ© pour la production avec layers cachÃ©s et image finale minimale
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STAGE 1 : Build avec Maven
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM maven:3.9-eclipse-temurin-21-alpine AS builder

LABEL maintainer="NexusAI Team <support@nexusai.com>"
LABEL description="NexusAI Authentication Service - Build Stage"

# CrÃ©er le rÃ©pertoire de travail
WORKDIR /app

# Copier les fichiers POM pour le caching des dÃ©pendances
COPY pom.xml .
COPY nexus-core/pom.xml nexus-core/
COPY nexus-auth/pom.xml nexus-auth/

# TÃ©lÃ©charger les dÃ©pendances (cette layer sera cachÃ©e)
RUN mvn dependency:go-offline -B

# Copier le code source
COPY nexus-core/src nexus-core/src
COPY nexus-auth/src nexus-auth/src

# Compiler et packager (skip tests pour build plus rapide)
RUN mvn clean package -DskipTests -B

# Extraire le JAR pour optimiser les layers Docker
RUN mkdir -p nexus-auth/target/dependency && \
    cd nexus-auth/target/dependency && \
    jar -xf ../*.jar

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# STAGE 2 : Image finale minimale
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM eclipse-temurin:21-jre-alpine

LABEL maintainer="NexusAI Team <support@nexusai.com>"
LABEL description="NexusAI Authentication Service - Production"
LABEL version="1.0.0"

# Installer des utilitaires nÃ©cessaires
RUN apk add --no-cache \
    curl \
    tini \
    && rm -rf /var/cache/apk/*

# CrÃ©er un utilisateur non-root pour la sÃ©curitÃ©
RUN addgroup -g 1001 nexusai && \
    adduser -D -u 1001 -G nexusai nexusai

# CrÃ©er les rÃ©pertoires nÃ©cessaires
RUN mkdir -p /app/logs && \
    chown -R nexusai:nexusai /app

WORKDIR /app

# Copier l'application depuis le stage de build
ARG DEPENDENCY=/app/nexus-auth/target/dependency
COPY --from=builder ${DEPENDENCY}/BOOT-INF/lib ./lib
COPY --from=builder ${DEPENDENCY}/META-INF ./META-INF
COPY --from=builder ${DEPENDENCY}/BOOT-INF/classes .

# Changer l'ownership
RUN chown -R nexusai:nexusai /app

# Passer Ã  l'utilisateur non-root
USER nexusai

# Exposer le port
EXPOSE 8081

# Variables d'environnement par dÃ©faut
ENV SPRING_PROFILES_ACTIVE=prod \
    JAVA_OPTS="-XX:+UseContainerSupport \
               -XX:MaxRAMPercentage=75.0 \
               -XX:InitialRAMPercentage=50.0 \
               -XX:+UseG1GC \
               -XX:+UseStringDeduplication \
               -XX:+OptimizeStringConcat \
               -Djava.security.egd=file:/dev/./urandom"

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8081/actuator/health || exit 1

# Utiliser tini comme init system
ENTRYPOINT ["/sbin/tini", "--"]

# Commande de dÃ©marrage
CMD java ${JAVA_OPTS} \
    -cp .:lib/* \
    com.nexusai.auth.NexusAuthApplication

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# .dockerignore - Ã€ crÃ©er Ã  la racine du projet
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Compiled class files
**/target/
**/*.class

# Log files
**/*.log
**/logs/

# Package Files
**/*.jar
**/*.war
**/*.ear

# IDE
**/.idea/
**/*.iml
**/.vscode/
**/.project
**/.classpath
**/.settings/

# OS
**/.DS_Store
**/Thumbs.db

# Git
.git/
.gitignore

# Docker
Dockerfile
.dockerignore
docker-compose.yml

# Documentation
README.md
docs/

# Test files
**/src/test/

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# docker-compose.prod.yml - Configuration production
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

version: '3.8'

services:
  nexus-auth:
    image: nexusai/nexus-auth:1.0.0
    container_name: nexusai-auth-prod
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DATABASE_URL: jdbc:postgresql://postgres:5432/nexusai_auth
      DATABASE_USERNAME: ${DB_USER}
      DATABASE_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JAVA_OPTS: >
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=75.0
        -XX:+UseG1GC
        -Xlog:gc*:file=/app/logs/gc.log:time,uptime:filecount=5,filesize=10M
    volumes:
      - ./logs:/app/logs
    networks:
      - nexusai-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  postgres:
    image: postgres:16-alpine
    container_name: nexusai-postgres-prod
    restart: unless-stopped
    environment:
      POSTGRES_DB: nexusai_auth
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    networks:
      - nexusai-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d nexusai_auth"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: nexusai-redis-prod
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data_prod:/data
    networks:
      - nexusai-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

volumes:
  postgres_data_prod:
  redis_data_prod:

networks:
  nexusai-network:
    driver: bridge

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Scripts de build et dÃ©ploiement
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

#!/bin/bash
# build-docker.sh

set -e

echo "ğŸ³ Building Docker image..."

# Build l'image
docker build -t nexusai/nexus-auth:latest .
docker build -t nexusai/nexus-auth:1.0.0 .

echo "âœ“ Docker image built successfully"

# Tag pour le registry (si nÃ©cessaire)
# docker tag nexusai/nexus-auth:1.0.0 registry.nexusai.com/nexus-auth:1.0.0

echo "ğŸ“¦ Image size:"
docker images nexusai/nexus-auth:latest

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

#!/bin/bash
# deploy-docker.sh

set -e

echo "ğŸš€ Deploying NexusAI Auth Service..."

# Pull les derniÃ¨res images
docker-compose -f docker-compose.prod.yml pull

# DÃ©marrer les services
docker-compose -f docker-compose.prod.yml up -d

# Attendre que les services soient prÃªts
echo "â³ Waiting for services to be ready..."
sleep 30

# VÃ©rifier la santÃ©
docker-compose -f docker-compose.prod.yml ps

echo "âœ“ Deployment complete!"
echo "Application: http://localhost:8081"
